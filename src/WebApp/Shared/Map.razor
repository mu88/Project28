@using BusinessServices.Services
@using DTO.LifePoint
@using DTO.Location
@using System.Text.Json
@implements IAsyncDisposable
@inject IJSRuntime _jsRuntime
@inject ILifePointService _lifePointService
@inject IPersonService _personService

<div id="mapid"></div>

@code {

    // Will be initialized on startup
#pragma warning disable 8618
    private IJSObjectReference _module;
    private IJSObjectReference _map;
#pragma warning restore 8618
    private IReadOnlyList<ExistingLocation> _allLocations = new List<ExistingLocation>();
    private Dictionary<Guid, IJSObjectReference> _allMarkers = new();
    private DotNetObjectReference<Map>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await InitializeMap(_objRef);
            await RedrawAllLocationsAsync();
        }
    }

    /// <inheritdoc />
    protected override Task OnInitializedAsync()
    {
        ReloadAllLocations();

        return base.OnInitializedAsync();
    }

    private void ReloadAllLocations() => _allLocations = _lifePointService.GetAllLocations().ToList();

    private async Task InitializeMap(DotNetObjectReference<Map> dotNetObjectReference)
    {
        _module = await _jsRuntime.InvokeAsync<IJSObjectReference>("import", "./map.js");
        _map = await _module.InvokeAsync<IJSObjectReference>("initializeMap", 51.0405849, 13.7478431, 20, dotNetObjectReference);
    }

    private async Task RedrawAllLocationsAsync()
    {
    // TODO mu88: Delete existing markers from map
        _allMarkers.Clear();

        foreach (var location in _allLocations)
            _allMarkers.Add(location.Id, await AddMarkerAsync(location));
    }

    private async ValueTask<IJSObjectReference> AddMarkerAsync(ExistingLocation location) =>
        await _module.InvokeAsync<IJSObjectReference>("addMarker", _map, location.Id, location.Latitude, location.Longitude);

    [JSInvokable]
    public async Task CreateNewLifePointAsync(JsonElement lng, JsonElement lat)
    {
        var longitude = lng.GetDouble();
        var latitude = lat.GetDouble();
        var lifePointToCreate = new LifePointToCreate(DateOnly.FromDateTime(DateTime.Now), "Test", "Test", latitude, longitude, _personService.GetAllPersons().First().Id);

        await _lifePointService.CreateLifePointAsync(lifePointToCreate);
    }

    [JSInvokable]
    public async Task ReloadAndDrawAllLocationsAsync()
    {
        ReloadAllLocations();
        await RedrawAllLocationsAsync();
    }

    /// <inheritdoc />
    public async ValueTask DisposeAsync()
    {
    // TODO mu88: Check if disposing is necessary with .NET 6 as it causes errors an app shutdown

    // ReSharper disable once ConditionIsAlwaysTrueOrFalse
    // Due to unknown reasons, this method will be called before _module could be loaded.
    // Maybe it is related to the preview nature of .NET 6
        if (_module is not null) { await _module.DisposeAsync(); }
        _objRef?.Dispose();
    }

}