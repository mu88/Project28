@using BusinessServices.Services
@using DTO.LifePoint
@using Persistence
@using WebApp.Models
@using System.IO
@inject ILifePointService _lifePointService
@inject IPersonService _personService
@inject IJSRuntime _jsRuntime
@inject IUserService _userService
@inject IStringLocalizer<Main> _loc

@if (_showModalSpinner)
{
    <div class="spinner-border"></div>
    <div>@_loc["Saving"]...</div>
}
else
{
    @if (_imageTooBig)
    {
        <p>@_loc["ImageTooBig", MaxAllowedFileSizeInMegaBytes]</p>
    }

    <EditForm Model="@_newLifePoint" OnValidSubmit="@CreateNewLifePointAsync">
        <DataAnnotationsValidator/>
        <ValidationSummary/>

        <label for="caption">@_loc["Caption"]</label>
        <InputText id="caption" @bind-Value="_newLifePoint.Caption"/>
        <label for="date">@_loc["Date"]</label>
        <InputDate id="date" @bind-Value="_newLifePoint.Date"/>
        <label for="description">@_loc["Description"]</label>
        <InputText id="description" @bind-Value="_newLifePoint.Description"/>
        <label for="image">@_loc["Image"]</label>
        <InputFile id="image" OnChange="@LoadImage" accept=".jpg,.jpeg,.png"/>

        <button type="submit">@_loc["Save"]</button>
    </EditForm>
}

@code {

    private readonly NewLifePointModel _newLifePoint = new();
    private IJSObjectReference _newLifePointModule = null!; // is initialized on component construction 
    private IBrowserFile? _file;
    private bool _showModalSpinner;
    private bool _imageTooBig;
        private const long MaxAllowedFileSizeInBytes = MaxAllowedFileSizeInMegaBytes * 1024 * 1024;
        private const long MaxAllowedFileSizeInMegaBytes = 15;

    [Parameter]
    public double Latitude { get; set; }

    [Parameter]
    public double Longitude { get; set; }

    private async Task CreateNewLifePointAsync()
    {
        EnableSpinner();

        ImageToCreate? imageToCreate;
        try
        {
            _imageTooBig = false;
            imageToCreate = _file != null ? new ImageToCreate(_file.OpenReadStream(MaxAllowedFileSizeInBytes)) : null;
        }
        catch (IOException)
        {
            DisableSpinner();
            _imageTooBig = true;
            return;
        }
        var lifePointToCreate = new LifePointToCreate(
            _newLifePoint.Date,
            _newLifePoint.Caption,
            _newLifePoint.Description,
            Latitude,
            Longitude,
            _userService.Id ?? throw new NullReferenceException(_loc["UserHasNotBeenSet"]),
            imageToCreate);

        var createdLifePoint = await _lifePointService.CreateLifePointAsync(lifePointToCreate);

        DisableSpinner();

        await RemovePopupAsync();
        await AddMarkerAsync(createdLifePoint);
    }

    private void EnableSpinner()
    {
        _showModalSpinner = true;
        StateHasChanged();
    }

    private void DisableSpinner()
    {
        _showModalSpinner = false;
        StateHasChanged();
    }

    private async Task RemovePopupAsync() => await _newLifePointModule.InvokeVoidAsync("removePopupForNewLifePoint");

    private async Task AddMarkerAsync(ExistingLifePoint existingLifePoint) =>
        await _newLifePointModule.InvokeVoidAsync("addMarkerForCreatedLifePoint", existingLifePoint.Id, existingLifePoint.Latitude, existingLifePoint.Longitude);

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        await LoadNewLifePointModuleAsync();

        await base.OnInitializedAsync();
    }

    private async Task LoadNewLifePointModuleAsync() => _newLifePointModule = await _jsRuntime.InvokeAsync<IJSObjectReference>("import", "./Shared/NewLifePoint.razor.js");

    private void LoadImage(InputFileChangeEventArgs args) => _file = args.File;

}